<!DOCTYPE html>
<html>
<head>
    <title>Trip Manager</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }
        .day {
            background: white;
            border: 1px solid #ddd;
            padding: 10px;
            min-height: 80px;
        }
        .trip {
            background: #e3f2fd;
            margin: 2px 0;
            padding: 2px 5px;
            border-radius: 3px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Trip Manager</h1>
        <div id="month-year"></div>
        <div class="calendar" id="calendar"></div>
        <div id="details"></div>
    </div>

    <script>
        const SERVER_URL = 'https://tripmanager:5000';
        let tgUser = null;
        let currentDate = new Date();
        
        // Инициализация Telegram WebApp
        function initTelegramApp() {
            tgUser = window.Telegram.WebApp.initDataUnsafe.user;
            if (!tgUser) {
                alert('Please open in Telegram');
                return;
            }
            
            // Проверяем авторизацию
            fetch(`${SERVER_URL}/api/auth`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Telegram-User-ID': tgUser.id
                },
                body: JSON.stringify({ user_id: tgUser.id })
            })
            .then(() => loadData())
            .catch(err => console.error('Auth error:', err));
        }
        
        // Загрузка данных
        async function loadData() {
            try {
                const [employees, trips] = await Promise.all([
                    fetchData('employees'),
                    fetchData('trips')
                ]);
                
                renderCalendar(employees, trips);
            } catch (err) {
                console.error('Load error:', err);
                alert('Error loading data');
            }
        }
        
        // Запрос к серверу
        async function fetchData(dataset) {
            const response = await fetch(`${SERVER_URL}/api/data/${dataset}`, {
                headers: {
                    'X-Telegram-User-ID': tgUser.id
                }
            });
            
            if (!response.ok) throw new Error('Network error');
            return await response.json();
        }
        
        // Рендер календаря
        function renderCalendar(employees, trips) {
            document.getElementById('month-year').textContent = 
                `${currentDate.toLocaleString('default', { month: 'long' })} ${currentDate.getFullYear()}`;
                
            const calendarEl = document.getElementById('calendar');
            calendarEl.innerHTML = '';
            
            // Заголовки дней недели
            ['Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб', 'Вс'].forEach(day => {
                const dayEl = document.createElement('div');
                dayEl.textContent = day;
                dayEl.style.fontWeight = 'bold';
                calendarEl.appendChild(dayEl);
            });
            
            // Дни месяца
            const daysInMonth = new Date(
                currentDate.getFullYear(), 
                currentDate.getMonth() + 1, 
                0
            ).getDate();
            
            for (let day = 1; day <= daysInMonth; day++) {
                const dayEl = document.createElement('div');
                dayEl.className = 'day';
                dayEl.innerHTML = `<div>${day}</div>`;
                
                const dateStr = `${currentDate.getFullYear()}-${(currentDate.getMonth()+1).toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
                
                // Фильтруем командировки на этот день
                const dayTrips = trips.filter(trip => 
                    dateStr >= trip.start_date && dateStr <= trip.end_date
                );
                
                // Добавляем командировки в день
                dayTrips.forEach(trip => {
                    const employee = employees.find(e => e.id === trip.employee_id);
                    const tripEl = document.createElement('div');
                    tripEl.className = 'trip';
                    tripEl.textContent = employee ? employee.name : 'Unknown';
                    tripEl.onclick = () => showTripDetails(trip, employee);
                    dayEl.appendChild(tripEl);
                });
                
                calendarEl.appendChild(dayEl);
            }
        }
        
        // Показать детали командировки
        function showTripDetails(trip, employee) {
            const detailsEl = document.getElementById('details');
            detailsEl.innerHTML = `
                <h2>Командировка</h2>
                <p><strong>Сотрудник:</strong> ${employee?.name || 'Неизвестный'}</p>
                <p><strong>Место:</strong> ${trip.destination}</p>
                <p><strong>Цель:</strong> ${trip.purpose}</p>
                <p><strong>Даты:</strong> ${trip.start_date} - ${trip.end_date}</p>
            `;
        }
        
        // Инициализация при загрузке
        document.addEventListener('DOMContentLoaded', initTelegramApp);
    </script>
</body>
</html>